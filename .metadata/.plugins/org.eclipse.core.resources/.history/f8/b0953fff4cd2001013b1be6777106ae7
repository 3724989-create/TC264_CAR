
#include "Self_mtv90x.h"

#define row1 70
#define col1 188
uint8 Process_Array[row1][col1];

void self_mtv90x_init(void)
{
    ips114_init();
    ips114_show_string(0, 0, "mt9v03x init.");
    while(1)
    {
        if(mt9v03x_init())
            ips114_show_string(0, 16, "mt9v03x reinit.");
        else
            break;
        system_delay_ms(500);                                                   // 鐭欢鏃跺揩閫熼棯鐏〃绀哄紓甯�
    }

}

uint8 my_adapt_threshold(uint8 *image,uint16 col,uint16 row)
{
    #define GrayScale 256
    uint16 width =col;
    uint16 height =row;
    int pixelCount[GrayScale];
    float pixelPRo[GrayScale];
    int i,j,pixelSum=(width)*(height-60)/9;
    uint8 threshold=0;
    uint8* data=image;
    uint32 gray_sum=0;
    float w0,w1,u0tmp,u1tmp,u0,u1,u,deltaTmp,deltaMax=0;

    for (i = 0; i < GrayScale; i++)
    {
        pixelCount[i]=0;
        pixelPRo[i]=0;
    }
    //缁熻鐏板害绾т腑姣忎釜鍍忕礌鍦ㄦ暣鏁板浘鍍忎腑鐨勪釜鏁�
    for ( i = 10; i < height-50; i+=3)
    {
       for (j = 0; j < width;j+=3)
       {
            pixelCount[(int)data[i*width+j]]++;//灏嗗綋鍓嶇偣鐨勫儚绱犲�间綔涓鸿鏁版暟鍊间笅鏍�
            gray_sum+=(int)data[i*width+j];    //鐏板害鍊兼�诲拰
       }
    }

    //璁＄畻姣忎釜鍍忕礌鍊肩殑鐐瑰湪姝ｈ礋鍥惧儚涓殑姣斾緥

    for ( i = 0; i <GrayScale; i++)
    {
        pixelPRo[i]=(float)pixelCount[i]/pixelSum;
    }
    
    w0=w1=u0tmp=u1tmp=u0=u1=u=deltaTmp=0;
    for(j=0;j<GrayScale;j++)    //褰撳墠灏濊瘯闃堝��
    {
        w0+=pixelPRo[j];    //鑳屾櫙閮ㄥ垎姣忎釜鐏板害鍊肩殑鍍忕礌鐐规墍鍗犳瘮渚嬩箣鍜岋紝鍗宠儗鏅儴鍒嗙殑姣斾緥
        u0tmp+=j*pixelPRo[j];   //鑳屾櫙閮ㄥ垎锛屾瘡涓伆搴﹀�肩殑鐐圭殑姣斾緥

        w1=1-w0;
        u1tmp=gray_sum/pixelSum-u0tmp;

        u0=u0tmp/w0;    //鑳屾櫙骞冲潎鐏板害
        u1=u1tmp/w1;    //鍓嶆櫙骞冲潎鐏板害
        u=u0tmp+u1tmp;
        deltaTmp=w0*pow((u0-u),2)+w1*pow((u1-u),2); //璁＄畻鏈�澶х被闂存柟宸�
        if(deltaTmp>deltaMax)
        {
            deltaMax=deltaTmp;
            threshold=(uint8)j;
        }
        if(deltaTmp<deltaMax)
        {
            break;
        }
    }
    
}

uint8 OTSU_Th;
uint8 Image_Value=80;
void Binarization(void)
{
    uint8 threshold=0;
    threshold=Limit_ab_uint8(my_adapt_threshold(mt9v03x_image[0],MT9V03X_W,MT9V03X_H),Image_Value,250);
    OTSU_Th=threshold;
    float zenyi=0,zenyj=0;
    int X,Y;

    for(int Y = 10;Y < 10+row1; Y++)
    {
        if(Y < 60)
        {
            zenyi=4;
        }

        for(int X = 0;X < col1;X++)
        {
            zenyj = (float)abs(X-93)/92.0*12.0;
            Process_Array[Y-10][X] = (mt9v03x_image[Y][X] > OTSU_Th+zenyi-zenyj) ? 0xff : 0x00;//1鐧� 0榛�
            //浣垮緱杈圭紭鍖哄煙鐨勫儚绱犳洿瀹规槗婊¤冻 mt9v03x_image[Y][X] > Threshold 鐨勬潯浠讹紝浠庤�屾洿瀹规槗琚垽鏂负鐧借壊锛堣儗鏅級
        }
    }
    

}

void self_mtv90x_process(void)
{
        if(mt9v03x_finish_flag)
        {
            //ips114_displayimage03x((const uint8 *)mt9v03x_image, MT9V03X_W, MT9V03X_H);                             // 鏄剧ず鍘熷鍥惧儚
            Binarization();
            ips114_displayimage03x((const uint8 *)Process_Array, row1, col1);
//            ips114_show_gray_image(0, 0, (const uint8 *)mt9v03x_image, MT9V03X_W, MT9V03X_H, 240, 135, 64);       // 鏄剧ず鐏板害鍥惧儚
            mt9v03x_finish_flag = 0;
        }
}

